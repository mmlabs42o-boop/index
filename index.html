<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Stream Overlay - Horde Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: transparent; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }
        #ai-image { max-width: 90%; max-height: 75vh; border: 8px solid white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: opacity 1.5s; opacity: 0; }
        #ai-image.show { opacity: 1; }
        #prompt-display { position: absolute; bottom: 40px; background: rgba(0, 0, 0, 0.8); padding: 15px 25px; border-radius: 50px; font-size: 20px; border: 2px solid #6441a5; transition: opacity 1s; opacity: 0; z-index: 20; }
        #prompt-display.show { opacity: 1; }
        #stats-panel { position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.75); padding: 10px 15px; border-radius: 10px; border-left: 4px solid #00f2ff; font-family: monospace; color: #00f2ff; text-shadow: 0 0 5px #00f2ff; z-index: 50; }
        #status { font-size: 22px; text-shadow: 2px 2px 5px black; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 8px; position: absolute; top: 20px; display: none; z-index: 100; }
        #wheel-container { position: absolute; display: none; flex-direction: column; align-items: center; opacity: 0; transition: opacity 0.5s; }
        #wheel { width: 300px; height: 300px; border-radius: 50%; border: 8px solid #fff; position: relative; transition: transform 3s cubic-bezier(0.15, 0, 0.15, 1); background: conic-gradient(#ff4d4d 0deg 60deg, #4d94ff 60deg 120deg, #4dff88 120deg 180deg, #ffff4d 180deg 240deg, #ff4dff 240deg 300deg, #ffa31a 300deg 360deg); }
        .label { position: absolute; width: 100%; height: 100%; text-align: center; font-weight: bold; font-size: 10px; padding-top: 25px; transform-origin: 50% 50%; color: black; }
    </style>
</head>
<body>

    <div id="stats-panel">
        <div>GENS: <span id="count-val">0</span></div>
        <div>KUDOS: <span id="kudos-val">0</span></div>
    </div>

    <div id="status">ðŸ”„ Initializing...</div>
    <div id="prompt-display">Prompt...</div>
    
    <div id="wheel-container">
        <div id="wheel">
            <div class="label" style="transform: rotate(30deg)">Spooky</div>
            <div class="label" style="transform: rotate(90deg)">Cute</div>
            <div class="label" style="transform: rotate(150deg)">Absurd</div>
            <div class="label" style="transform: rotate(210deg)">Funny</div>
            <div class="label" style="transform: rotate(270deg)">Abstract</div>
            <div class="label" style="transform: rotate(330deg)">Cartoon</div>
        </div>
    </div>

    <img id="ai-image" src="" />

    <script>
        const channel = "Monstermind42o"; 
        const displayTime = 25000;
        const idleDelay = 15000;
        
        const img = document.getElementById('ai-image');
        const status = document.getElementById('status');
        const promptBanner = document.getElementById('prompt-display');
        const wheelContainer = document.getElementById('wheel-container');
        const wheel = document.getElementById('wheel');
        const countUI = document.getElementById('count-val');
        const kudosUI = document.getElementById('kudos-val');

        let queue = [];
        let isProcessing = false;
        let totalGens = 0;
        let totalKudos = 0;
        let currentRotation = 0;
        let idleTimer;
        const categories = ["Spooky", "Cute", "Absurd", "Funny", "Abstract", "Cartoon"];

        ComfyJS.Init(channel);
        ComfyJS.onCommand = (user, command, message) => {
            if (command === "imagine" && message) {
                queue.push({ user, prompt: message });
                if(!isProcessing) processQueue();
            }
        };

        async function processQueue() {
            if (isProcessing || queue.length === 0) return;
            isProcessing = true;
            clearTimeout(idleTimer);
            
            wheelContainer.style.opacity = "0";
            setTimeout(() => { wheelContainer.style.display = 'none'; }, 500);

            const task = queue.shift();
            await generateHordeImage(task.prompt, task.user);

            setTimeout(() => {
                img.classList.remove('show');
                promptBanner.classList.remove('show');
                setTimeout(() => {
                    isProcessing = false;
                    if (queue.length > 0) processQueue();
                    else idleTimer = setTimeout(startIdleMode, idleDelay);
                }, 2000);
            }, displayTime);
        }

        async function generateHordeImage(prompt, user) {
            status.innerText = `ðŸŽ² Calling the Horde...`;
            status.style.display = "block";

            try {
                const response = await fetch("https://stablehorde.net/api/v2/generate/async", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "apikey": "0000000000" },
                    body: JSON.stringify({
                        prompt: prompt,
                        params: { n: 1, steps: 20, width: 512, height: 512 },
                        models: ["stable_diffusion"]
                    })
                });
                const data = await response.json();
                const uuid = data.id;

                let checkReady = false;
                while (!checkReady) {
                    const statusRes = await fetch(`https://stablehorde.net/api/v2/generate/status/${uuid}`);
                    const statusData = await statusRes.json();
                    
                    if (statusData.done) {
                        img.src = statusData.generations[0].img;
                        totalGens++;
                        totalKudos += Math.round(statusData.generations[0].kudos || 12);
                        countUI.innerText = totalGens;
                        kudosUI.innerText = totalKudos.toLocaleString();
                        checkReady = true;
                    } else {
                        await new Promise(r => setTimeout(r, 2000));
                    }
                }

                img.onload = () => {
                    status.style.display = "none";
                    promptBanner.innerText = `${user}: "${prompt}"`;
                    img.classList.add('show');
                    promptBanner.classList.add('show');
                };
            } catch (err) {
                status.innerText = "âŒ Horde Busy...";
                setTimeout(() => { status.style.display="none"; }, 3000);
                isProcessing = false; // Reset to allow next try
            }
        }

        function startIdleMode() {
            if (queue.length > 0 || isProcessing) return;
            wheelContainer.style.display = 'flex';
            setTimeout(() => { wheelContainer.style.opacity = "1"; }, 50);
            currentRotation += (1440 + Math.floor(Math.random() * 360));
            wheel.style.transform = `rotate(${currentRotation}deg)`;

            setTimeout(() => {
                const sliceIndex = Math.floor(((360 - (currentRotation % 360)) % 360) / 60);
                const chosenCategory = categories[sliceIndex];
                // Trigger Horde directly for idle
                generateHordeImage(`A high quality ${chosenCategory} masterpiece`, "AI Dream");
            }, 3500);
        }

        // Initial launch
        idleTimer = setTimeout(startIdleMode, 3000);
    </script>
</body>
</html>

    <div id="stats-panel">
        <div>GENS: <span id="count-val">0</span></div>
        <div>KUDOS: <span id="kudos-val">0</span></div>
    </div>

    <div id="gallery-container">
        <div style="text-align:center; font-weight:bold; margin-bottom:10px;">RECENT ART</div>
        <div id="gallery-list"></div>
        <div style="font-size:10px; text-align:center; opacity:0.7;">!gallery to toggle</div>
    </div>

    <div id="status">ðŸ”„ Initializing...</div>
    <div id="prompt-display">Prompt...</div>
    <img id="ai-image" src="" />

    <script>
        const channel = "Monstermind42o"; 
        const displayTime = 20000;
        
        const img = document.getElementById('ai-image');
        const status = document.getElementById('status');
        const promptBanner = document.getElementById('prompt-display');
        const galleryContainer = document.getElementById('gallery-container');
        const galleryList = document.getElementById('gallery-list');

        let queue = [];
        let history = []; // Stores the last 5 images
        let isProcessing = false;
        let totalGens = 0;
        let totalKudos = 0;

        ComfyJS.Init(channel);

        ComfyJS.onCommand = (user, command, message) => {
            if (command === "imagine" && message) {
                queue.push({ user, prompt: message });
                if(!isProcessing) processQueue();
            }
            if (command === "gallery") {
                galleryContainer.classList.toggle('active');
            }
            if (command === "last") {
                if (history.length > 0) {
                    // Re-display the latest history item
                    displayArchive(history[0]);
                }
            }
        };

        async function processQueue() {
            if (isProcessing || queue.length === 0) return;
            isProcessing = true;
            
            const task = queue.shift();
            await generateHordeImage(task.prompt, task.user);

            setTimeout(() => {
                img.classList.remove('show');
                promptBanner.classList.remove('show');
                setTimeout(() => {
                    isProcessing = false;
                    if (queue.length > 0) processQueue();
                }, 2000);
            }, displayTime);
        }

        async function generateHordeImage(prompt, user) {
            status.innerText = `ðŸŽ² Calling the Horde...`;
            status.style.display = "block";

            try {
                const response = await fetch("https://stablehorde.net/api/v2/generate/async", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "apikey": "0000000000" },
                    body: JSON.stringify({
                        prompt: prompt,
                        params: { n: 1, steps: 20, width: 512, height: 512 },
                        models: ["stable_diffusion"]
                    })
                });
                const data = await response.json();
                const uuid = data.id;

                let checkReady = false;
                while (!checkReady) {
                    const statusRes = await fetch(`https://stablehorde.net/api/v2/generate/status/${uuid}`);
                    const statusData = await statusRes.json();
                    
                    if (statusData.done) {
                        const imgUrl = statusData.generations[0].img;
                        
                        // Add to history (limit to 5)
                        history.unshift({ url: imgUrl, prompt: prompt, user: user });
                        if(history.length > 5) history.pop();
                        updateGalleryUI();

                        img.src = imgUrl;
                        totalGens++;
                        totalKudos += Math.round(statusData.generations[0].kudos || 12);
                        document.getElementById('count-val').innerText = totalGens;
                        document.getElementById('kudos-val').innerText = totalKudos.toLocaleString();
                        
                        checkReady = true;
                    } else {
                        await new Promise(r => setTimeout(r, 2000));
                    }
                }

                img.onload = () => {
                    status.style.display = "none";
                    promptBanner.innerText = `${user}: "${prompt}"`;
                    img.classList.add('show');
                    promptBanner.classList.add('show');
                };
            } catch (err) {
                status.innerText = "âŒ Horde Busy...";
            }
        }

        function updateGalleryUI() {
            galleryList.innerHTML = "";
            history.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = `<div class="gallery-label">${item.user}</div>
                                 <img class="gallery-item" src="${item.url}">`;
                galleryList.appendChild(div);
            });
        }

        function displayArchive(item) {
            img.src = item.url;
            promptBanner.innerText = `REPLAY - ${item.user}: "${item.prompt}"`;
            img.classList.add('show');
            promptBanner.classList.add('show');
            setTimeout(() => {
                img.classList.remove('show');
                promptBanner.classList.remove('show');
            }, 8000);
        }

    </script>
</body>
</html>