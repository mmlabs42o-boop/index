<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Stream Overlay Master</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: transparent; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }
        #ai-image { max-width: 90%; max-height: 75vh; border: 8px solid white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: opacity 1.5s ease-in-out; opacity: 0; }
        #ai-image.show { opacity: 1; }
        #prompt-display { position: absolute; bottom: 40px; background: rgba(0, 0, 0, 0.8); padding: 15px 25px; border-radius: 50px; font-size: 20px; max-width: 80%; text-align: center; border: 2px solid #6441a5; transition: opacity 1s; opacity: 0; z-index: 20; }
        #prompt-display.show { opacity: 1; }
        #wheel-container { position: absolute; display: none; flex-direction: column; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.5s; }
        #wheel { width: 300px; height: 300px; border-radius: 50%; border: 8px solid #fff; position: relative; transition: transform 3s cubic-bezier(0.15, 0, 0.15, 1); background: conic-gradient(#ff4d4d 0deg 60deg, #4d94ff 60deg 120deg, #4dff88 120deg 180deg, #ffff4d 180deg 240deg, #ff4dff 240deg 300deg, #ffa31a 300deg 360deg); }
        #arrow { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid white; position: absolute; top: -10px; z-index: 110; }
        .label { position: absolute; width: 100%; height: 100%; text-align: center; font-weight: bold; font-size: 12px; text-transform: uppercase; padding-top: 25px; transform-origin: 50% 50%; color: black; }
        #status { font-size: 24px; text-shadow: 2px 2px 5px black; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 8px; position: absolute; top: 20px; z-index: 10; display: none; }
    </style>
</head>
<body>

    <div id="status">ðŸ”„ Initializing...</div>
    <div id="prompt-display">Prompt...</div>

    <div id="wheel-container">
        <div id="arrow"></div>
        <div id="wheel">
            <div class="label" style="transform: rotate(30deg)">Spooky</div>
            <div class="label" style="transform: rotate(90deg)">Cute</div>
            <div class="label" style="transform: rotate(150deg)">Absurd</div>
            <div class="label" style="transform: rotate(210deg)">Funny</div>
            <div class="label" style="transform: rotate(270deg)">Abstract</div>
            <div class="label" style="transform: rotate(330deg)">Cartoon</div>
        </div>
        <h2 style="text-shadow: 2px 2px 10px black; margin-top: 20px;">Stable Diffusion Selection</h2>
    </div>

    <img id="ai-image" src="" />

    <script>
        const channel = "Monstermind42o"; // CHANGE THIS
        const displayTime = 25000;      
        const idleDelay = 15000;        

        const status = document.getElementById('status');
        const img = document.getElementById('ai-image');
        const promptBanner = document.getElementById('prompt-display');
        const wheelContainer = document.getElementById('wheel-container');
        const wheel = document.getElementById('wheel');
        
        let queue = [];
        let isProcessing = false;
        let idleTimer;
        let currentRotation = 0;
        const categories = ["Spooky", "Cute", "Absurd", "Funny", "Abstract", "Cartoon"];
        const bannedWords = ["nude", "naked", "porn", "sex", "nsfw", "gore", "blood", "kill", "suicide", "murder", "dead", "faggot", "nigger", "kike", "retard", "tranny", "slut", "rape", "hentai", "racist", "hitler", "nazi", "terrorist", "bomb", "cocaine", "meth", "heroin"];

        ComfyJS.Init(channel);

        ComfyJS.onCommand = (user, command, message) => {
            if (command === "imagine" && message) {
                const isClean = !bannedWords.some(word => message.toLowerCase().includes(word.toLowerCase()));
                if (!isClean) return;
                queue.push({ user, prompt: message });
                processQueue();
            }
        };

        async function processQueue() {
            if (isProcessing || queue.length === 0) return;
            isProcessing = true;
            clearTimeout(idleTimer);
            wheelContainer.style.opacity = "0";
            setTimeout(() => { wheelContainer.style.display = 'none'; }, 500);

            const currentTask = queue.shift();
            await displayImage(currentTask.prompt, currentTask.user);

            setTimeout(() => {
                img.classList.remove('show'); 
                promptBanner.classList.remove('show');
                setTimeout(() => {
                    isProcessing = false;
                    if (queue.length > 0) {
                        processQueue();
                    } else {
                        idleTimer = setTimeout(startIdleMode, idleDelay); 
                    }
                }, 2000);
            }, displayTime); 
        }

        async function startIdleMode() {
            if (queue.length > 0 || isProcessing) return;
            wheelContainer.style.display = 'flex';
            setTimeout(() => { wheelContainer.style.opacity = "1"; }, 50);

            currentRotation += (1440 + Math.floor(Math.random() * 360)); 
            wheel.style.transform = `rotate(${currentRotation}deg)`;

            setTimeout(async () => {
                const sliceIndex = Math.floor(((360 - (currentRotation % 360)) % 360) / 60);
                const category = categories[sliceIndex];
                
                // Backup prompts in case the Text AI is being flaky
                const localBackups = {
                    "Spooky": "A haunted Victorian mansion with glowing green ghosts",
                    "Cute": "A tiny baby dragon sleeping on a pile of gold coins",
                    "Absurd": "A giant slice of pizza wearing a tuxedo at the opera",
                    "Funny": "A detective dog wearing a hat and using a magnifying glass on a sausage",
                    "Abstract": "Vibrant swirls of liquid gold and neon purple ink",
                    "Cartoon": "A brave 3D animated squirrel wearing astronaut gear on the moon"
                };

                try {
                    const response = await fetch(`https://text.pollinations.ai/create%20a%20${category}%20image%20prompt?model=openai`);
                    let aiPrompt = await response.text();
                    
                    // IF the AI returns a "limit" or "busy" message, use our local backup instead
                    if (aiPrompt.toLowerCase().includes("limit") || aiPrompt.toLowerCase().includes("busy") || aiPrompt.length > 250) {
                        aiPrompt = localBackups[category];
                    }

                    wheelContainer.style.opacity = "0";
                    setTimeout(() => { 
                        wheelContainer.style.display = 'none'; 
                        displayImage(aiPrompt, "AI Dream");
                    }, 500);

                    idleTimer = setTimeout(startIdleMode, 60000);
                } catch(e) {
                    displayImage(localBackups[category], "AI Dream");
                }
            }, 3500);
        }

        async function displayImage(promptText, userName) {
            const seed = Math.floor(Math.random() * 1000000);
            // STABLE DIFFUSION FOCUS: We force the "flux" or "turbo" models which are more stable
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(promptText)}?seed=${seed}&width=1024&height=1024&model=flux&nologo=true`;

            return new Promise((resolve) => {
                const tempImg = new Image();
                tempImg.src = url;
                
                tempImg.onerror = () => {
                   console.log("Image load failed, skipping...");
                   resolve();
                };

                tempImg.onload = () => {
                    img.src = url;
                    promptBanner.innerText = `"${promptText}"`;
                    img.classList.add('show');
                    promptBanner.classList.add('show');
                    resolve();
                };
            });
        }

        setTimeout(startIdleMode, 3000);
    </script>
</body>
</html>