<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Stream Overlay - Monstermind42o Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background: transparent; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }
        
        #ai-image { max-width: 90%; max-height: 75vh; border: 8px solid white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: opacity 1.5s; opacity: 0; z-index: 10; }
        #ai-image.show { opacity: 1; }

        /* GALLERY GRID */
        #gallery-view { position: absolute; display: none; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 80%; z-index: 15; }
        .gallery-item { width: 100%; border: 4px solid white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        #prompt-display { position: absolute; bottom: 60px; background: rgba(0, 0, 0, 0.8); padding: 15px 25px; border-radius: 50px; font-size: 20px; border: 2px solid #6441a5; transition: opacity 1s; opacity: 0; z-index: 20; text-align: center; max-width: 80%; }
        #prompt-display.show { opacity: 1; }

        #timer-container { position: absolute; bottom: 20px; width: 60%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; display: none; border: 1px solid rgba(255,255,255,0.3); z-index: 60; }
        #timer-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #00f2ff, #6441a5); transition: width 0.3s ease; }

        #stats-panel { position: absolute; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.75); padding: 10px 15px; border-radius: 10px; border-left: 4px solid #00f2ff; font-family: monospace; color: #00f2ff; z-index: 50; }
        #status { font-size: 22px; text-shadow: 2px 2px 5px black; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 8px; position: absolute; top: 20px; display: none; z-index: 100; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="stats-panel">
        <div>GENS: <span id="count-val">0</span></div>
        <div>ENERGY: <span id="kudos-val">0</span></div>
    </div>

    <div id="status">ðŸ”„ Initializing...</div>
    <div id="prompt-display">Prompt...</div>
    
    <div id="timer-container">
        <div id="timer-bar"></div>
    </div>

    <div id="gallery-view"></div>
    <img id="ai-image" src="" />

    <script>
        const channel = "Monstermind42o"; 
        const displayTime = 25000; 
        const idleDelay = 10000;  
        
        const img = document.getElementById('ai-image');
        const galleryView = document.getElementById('gallery-view');
        const status = document.getElementById('status');
        const promptBanner = document.getElementById('prompt-display');
        const timerContainer = document.getElementById('timer-container');
        const timerBar = document.getElementById('timer-bar');
        const countUI = document.getElementById('count-val');
        const kudosUI = document.getElementById('kudos-val');

        let queue = [];
        let history = []; // STORES LAST 10 IMAGES
        let isProcessing = false;
        let totalGens = 0;
        let totalKudos = 0;
        let idleTimer = null;

        const dreamData = {
            "Spooky": { subjects: ["haunted castle", "ghostly figure", "dark forest"], details: ["foggy atmosphere", "moonlight", "VHS glitch"] },
            "Cyberpunk": { subjects: ["futuristic city", "cybernetic samurai", "neon market"], details: ["neon pink lighting", "rainy pavement", "synthwave vibes"] },
            "Absurd": { subjects: ["flying toaster", "cat on a pizza", "melting clock"], details: ["surreal colors", "trippy patterns"] },
            "Funny": { subjects: ["pug in a tux", "banana surfing", "dino in a tutu"], details: ["bright colors", "cartoony expressions"] },
            "Abstract": { subjects: ["liquid gold", "swirling galaxies", "fractals"], details: ["iridescent", "sharp focus"] },
            "Cartoon": { subjects: ["magical dragon", "superhero hamster", "alien explorer"], details: ["cel-shaded", "vibrant style"] }
        };

        ComfyJS.Init(channel);
        ComfyJS.onCommand = (user, command, message) => {
            if (command === "imagine" && message) {
                queue.push({ type: 'gen', user, prompt: message });
            } else if (command === "last") {
                queue.push({ type: 'last', user });
            } else if (command === "gallery") {
                queue.push({ type: 'gallery', user });
            }
            if(!isProcessing) processQueue();
        };

        async function processQueue() {
            if (isProcessing || queue.length === 0) return;
            isProcessing = true;
            if(idleTimer) clearTimeout(idleTimer);
            
            hideElements(); 
            const task = queue.shift();
            
            if (task.type === 'gen') {
                const success = await generateImage(task.prompt, task.user);
                if (success) await new Promise(r => setTimeout(r, displayTime));
            } 
            else if (task.type === 'last') {
                if (history.length > 0) {
                    const lastItem = history[0];
                    showImmediateImage(lastItem.url, `LAST GEN: ${lastItem.prompt}`);
                    await new Promise(r => setTimeout(r, 10000));
                }
            } 
            else if (task.type === 'gallery') {
                showGallery();
                await new Promise(r => setTimeout(r, 15000));
            }

            hideElements();
            setTimeout(() => {
                isProcessing = false;
                if (queue.length > 0) processQueue();
                else startIdleTimer();
            }, 2000);
        }

        async function generateImage(prompt, user, isIdle = false) {
            status.style.display = "block";
            timerContainer.style.display = "block";
            status.innerText = isIdle ? `ðŸŽ² AI DREAM: ${user}` : `ðŸŽ² CMD: ${user}`;

            const response = await fetch("https://stablehorde.net/api/v2/generate/async", {
                method: "POST",
                headers: { "Content-Type": "application/json", "apikey": "0000000000" },
                body: JSON.stringify({
                    prompt: prompt,
                    params: { n: 1, steps: 20, width: 512, height: 512 },
                    models: ["stable_diffusion"]
                })
            });
            const data = await response.json();
            if(!data.id) return false;

            let attempts = 0;
            while (attempts < 60) {
                const statusRes = await fetch(`https://stablehorde.net/api/v2/generate/status/${data.id}`);
                const statusData = await statusRes.json();
                
                if (statusData.done && statusData.generations) {
                    const url = statusData.generations[0].img;
                    // Add to history
                    history.unshift({ url, prompt, user });
                    if(history.length > 10) history.pop();
                    
                    return await showImmediateImage(url, isIdle ? `AI DREAM [${user}]: ${prompt}` : `${user}: "${prompt}"`, statusData.generations[0].kudos);
                } else {
                    attempts++;
                    timerBar.style.width = `${(attempts / 60) * 100}%`;
                    status.innerText = `â³ HORDE WORKING (${attempts}/60)...`;
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
            return false;
        }

        function showImmediateImage(url, bannerText, kudos = 0) {
            return new Promise(resolve => {
                img.src = url;
                img.onload = () => {
                    status.style.display = "none";
                    timerContainer.style.display = "none";
                    promptBanner.innerText = bannerText;
                    
                    if(kudos > 0) {
                        totalGens++;
                        totalKudos += Math.round(kudos);
                        countUI.innerText = totalGens;
                        kudosUI.innerText = totalKudos.toLocaleString();
                    }

                    img.classList.add('show');
                    promptBanner.classList.add('show');
                    resolve(true);
                };
            });
        }

        function showGallery() {
            galleryView.innerHTML = "";
            const itemsToShow = history.slice(0, 4);
            if(itemsToShow.length === 0) return;
            
            itemsToShow.forEach(item => {
                const gImg = document.createElement('img');
                gImg.src = item.url;
                gImg.className = "gallery-item";
                galleryView.appendChild(gImg);
            });
            
            galleryView.style.display = "grid";
            promptBanner.innerText = "RECENT GALLERY";
            promptBanner.classList.add('show');
        }

        function hideElements() {
            img.classList.remove('show');
            promptBanner.classList.remove('show');
            galleryView.style.display = "none";
            status.style.display = "none";
            timerContainer.style.display = "none";
        }

        function startIdleTimer() {
            if(idleTimer) clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                if (queue.length === 0 && !isProcessing) {
                    const keys = Object.keys(dreamData);
                    const category = keys[Math.floor(Math.random() * keys.length)];
                    const sub = dreamData[category].subjects[Math.floor(Math.random() * dreamData[category].subjects.length)];
                    const det = dreamData[category].details[Math.floor(Math.random() * dreamData[category].details.length)];
                    const idlePrompt = `${sub}, ${det}, highly detailed, cinematic lighting`;

                    queue.push({ type: 'gen', user: category, prompt: idlePrompt, isIdle: true });
                    processQueue();
                }
            }, idleDelay);
        }

        startIdleTimer();
    </script>